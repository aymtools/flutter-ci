name: Flutter Package Publish CI (Auto Mono / Single)

on:
  workflow_call:

jobs:
  publish:
    name: 'Publish to pub.dev'
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      # ---------------------------------
      #  Checkout
      # ---------------------------------
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Set up the Dart SDK and provision the OIDC token used for publishing.
      # The `dart` command from this step will be shadowed by the one from the
      # Flutter SDK below.
      - uses: dart-lang/setup-dart@e51d8e571e22473a2ddebf0ef8a2123f0ab2c02c

      # ---------------------------------
      #  Install yq
      # ---------------------------------
      - name: Install yq
        run: sudo snap install yq
      # ---------------------------------
      #  Parse tag & auto detect package
      # ---------------------------------
      - name: Parse tag
        id: tag
        run: |
          TAG="${{ github.ref_name }}"

          # monorepo: pkg-name-vX.Y.Z
          if [[ "$TAG" =~ ^([a-zA-Z0-9_-]+)-v([0-9]+\.[0-9]+\.[0-9]+.*)$ ]]; then
            PKG="${BASH_REMATCH[1]}"
            VERSION="${BASH_REMATCH[2]}"
            DIR="packages/$PKG"
          # single repo: vX.Y.Z
          elif [[ "$TAG" =~ ^v([0-9]+\.[0-9]+\.[0-9]+.*)$ ]]; then
            PKG=""
            VERSION="${BASH_REMATCH[1]}"
            DIR="."
          else
            echo "::error::Invalid tag format: $TAG"
            exit 1
          fi

          if [[ "$VERSION" =~ - ]]; then
            RELEASE=false
          else
            RELEASE=true
          fi
          
          if [ "$RELEASE" == "false" ]; then
            REGEX='^v[0-9]+\.[0-9]+\.[0-9]+-(pre|dev|beta|rc)\.[0-9]+$'
            if [[ ! "$TAG" =~ $REGEX ]]; then
              echo "::error::Invalid tag: $TAG"
              exit 1
            fi
          fi
          
          if [ ! -f "$DIR/pubspec.yaml" ]; then
            echo "::error::pubspec.yaml not found in $DIR"
            exit 1
          fi

          echo "package=$PKG" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "dir=$DIR" >> $GITHUB_OUTPUT
          echo "release=$RELEASE" >> $GITHUB_OUTPUT

          echo "üì¶ Package : ${PKG:-root}"
          echo "üìÅ Dir     : $DIR"
          echo "üè∑ Version : $VERSION"
          echo "üöÄ Release : $RELEASE"

      # ---------------------------------
      #  Ê†°È™å pubspec ‚Üî tag
      # ---------------------------------
      - name: Validate pubspec version
        working-directory: ${{ steps.tag.outputs.dir }}
        run: |
          PUBSPEC_VERSION=$(yq '.version' pubspec.yaml)
          if [ "$PUBSPEC_VERSION" != "${{ steps.tag.outputs.version }}" ]; then
            echo "::error::Tag version does not match pubspec.yaml"
            exit 1
          fi

      # ---------------------------------
      #  Extract minimum SDK
      # ---------------------------------
      - name: Extract minimum SDK
        id: min_sdk
        run: |
          CONSTRAINT=$(yq '.environment.flutter' pubspec.yaml)

          if [ -z "$CONSTRAINT" ] || [ "$CONSTRAINT" = "null" ]; then
            echo "::error::Missing environment constraint"
            exit 1
          fi

          MIN=$(echo "$CONSTRAINT" | sed -E 's/.*>=([0-9]+\.[0-9]+\.[0-9]+).*/\1/')
          echo "version=$MIN" >> $GITHUB_OUTPUT
          echo "üîΩ Minimum Flutter SDK: $MIN"

      # ---------------------------------
      #  Setup command aliases
      # ---------------------------------
      - name: Setup commands
        id: cmds
        run: |
          echo "pub=flutter pub" >> $GITHUB_OUTPUT
          echo "analyze=flutter analyze" >> $GITHUB_OUTPUT
          echo "test=flutter test " >> $GITHUB_OUTPUT
          echo "format=dart format --output=none --set-exit-if-changed lib" >> $GITHUB_OUTPUT

      # =====================================================================
      #  Setup minimum Dart SDK
      # =====================================================================
      - name: Setup minimum Flutter SDK
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ steps.min_sdk.outputs.version }}
          channel: stable

      # =====================================================================
      #  Minimum SDK analyze
      # =====================================================================
      - name: Analyze (minimum SDK)
        working-directory: ${{ steps.tag.outputs.dir }}
        run: |
          ${{ steps.cmds.outputs.pub }} get
          ${{ steps.cmds.outputs.analyze }} --fatal-infos --fatal-warnings  lib 

      # =====================================================================
      #  Clear cache
      # =====================================================================
      - name: Clean lock file and cache
        working-directory: ${{ steps.tag.outputs.dir }}
        run: |
          rm -f pubspec.lock
          rm -rf .dart_tool

      # =====================================================================
      #  Setup stable Flutter SDK
      # =====================================================================
      - name: Setup stable Flutter SDK
        uses: subosito/flutter-action@v2
        with:
          channel: stable

      # =====================================================================
      #  Stable SDK analyze
      # =====================================================================
      - name: Analyze (stable SDK)
        working-directory: ${{ steps.tag.outputs.dir }}
        run: |
          ${{ steps.cmds.outputs.pub }} get
          ${{ steps.cmds.outputs.analyze }} --fatal-infos --fatal-warnings  lib
          ${{ steps.cmds.outputs.analyze }}

      # =====================================================================
      #  Format check (stable)
      # =====================================================================
      - name: Format check
        working-directory: ${{ steps.tag.outputs.dir }}
        run: ${{ steps.cmds.outputs.format }}

      # ---------------------------------
      #  Test (stable)
      # ---------------------------------
      - name: Run tests
        working-directory: ${{ steps.tag.outputs.dir }}
        run: ${{ steps.cmds.outputs.test }}

      # ---------------------------------
      #  CHANGELOG Ê†°È™å ÁâàÊú¨Âè∑Ôºà‰ªÖ releaseÔºâ
      # ---------------------------------
      - name: Validate CHANGELOG
        if: steps.tag.outputs.release == 'true'
        working-directory: ${{ steps.tag.outputs.dir }}
        run: |

          if [ ! -f CHANGELOG.md ]; then
            echo "::error::CHANGELOG.md not found"
            exit 1
          fi

          if ! grep -q "^## ${{ steps.tag.outputs.version }}" CHANGELOG.md; then
            echo "::error::CHANGELOG.md missing version ${{ steps.tag.outputs.version }}"
            exit 1
          fi

      # ---------------------------------
      #  Publish (release only)
      # ---------------------------------

      - name: Publish dry-run
        if: steps.tag.outputs.release == 'true'
        working-directory: ${{ steps.tag.outputs.dir }}
        run: ${{ steps.cmds.outputs.pub }} publish --dry-run

      - name: Publish
        if: steps.tag.outputs.release == 'true'
        working-directory: ${{ steps.tag.outputs.dir }}
        run: ${{ steps.cmds.outputs.pub }} publish --force